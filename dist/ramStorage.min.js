!function(Backbone,_){function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}return Backbone.ramStorage=function(serializer){this.serializer=serializer||{serialize:function(item){return _.isObject(item)?JSON.stringify(item):item},deserialize:function(data){return data&&JSON.parse(data)}},this.records={}},_.extend(Backbone.ramStorage.prototype,{save:function(){},create:function(model){if(!model.id&&0!==model.id){model.id=guid();var data={};data[model.idAttribute]=model.id,model.set(data,{silent:!0})}return this.records[model.id]=model,this.find(model)},update:function(model){var modelId=model.id.toString();return _.has(this.records,modelId)||(this.records[modelId]=model),this.find(model)},find:function(model){return this[model.id.toString()]},findAll:function(){return this.records},destroy:function(model){var modelId=model.id.toString();return delete this.records[modelId],model}}),Backbone.ramStorage.sync=Backbone.localSync=function(method,model,options){var resp,errorMessage,store=_.result(model,"ramStorage")||_.result(model.collection,"ramStorage"),syncDfd=Backbone.$?Backbone.$.Deferred&&Backbone.$.Deferred():Backbone.Deferred&&Backbone.Deferred();switch(method){case"read":resp=_.isUndefined(model.id)?store.findAll():store.find(model);break;case"create":resp=store.create(model);break;case"update":resp=store.update(model);break;case"delete":resp=store.destroy(model)}return resp?(options&&options.success&&("0.9.10"===Backbone.VERSION?options.success(model,resp,options):options.success(resp)),syncDfd&&syncDfd.resolve(resp)):(errorMessage=errorMessage?errorMessage:"Record Not Found",options&&options.error&&("0.9.10"===Backbone.VERSION?options.error(model,errorMessage,options):options.error(errorMessage)),syncDfd&&syncDfd.reject(errorMessage)),options&&options.complete&&options.complete(resp),syncDfd&&syncDfd.promise()},Backbone.ajaxSync=Backbone.sync,Backbone.getSyncMethod=function(model,options){var forceAjaxSync=options&&options.ajaxSync;return forceAjaxSync||!_.result(model,"ramStorage")&&!_.result(model.collection,"ramStorage")?Backbone.ajaxSync:Backbone.localSync},Backbone.sync=function(method,model,options){return Backbone.getSyncMethod(model,options).apply(this,[method,model,options])},Backbone.ramStorage}(Backbone,_);